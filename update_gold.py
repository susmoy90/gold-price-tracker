import requests
import os
import datetime

def get_bdt_rate():
    try:
        # ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ï‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡¶≤‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        response = requests.get("https://api.exchangerate-api.com/v4/latest/USD")
        data = response.json()
        return data.get('rates', {}).get('BDT', 122.5)
    except:
        return 122.5

def get_gold_price():
    api_key = os.getenv("GOLD_API_KEY")
    url = "https://www.goldapi.io/api/XAU/USD"
    headers = {"x-access-token": api_key, "Content-Type": "application/json"}
    
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        gold_data = response.json()
        
        p24k_usd = gold_data.get('price_gram_24k', 0)
        usd_to_bdt = get_bdt_rate()
        v_gm = 11.664 # ‡ßß ‡¶≠‡¶∞‡¶ø = ‡ßß‡ßß.‡ß¨‡ß¨‡ß™ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ

        def f_bdt(val):
            return "{:,.0f}".format(val)

        current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # ‡¶∏‡¶æ‡¶á‡¶ü‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
        output = f"# üí∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ó‡ßã‡¶≤‡ßç‡¶° ‡¶π‡ßã‡¶≤‡¶∏‡ßá‡¶≤ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü\n"
        output += f"**‡¶∂‡ßá‡¶∑ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü:** {current_time} | **‡¶°‡¶≤‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ü:** 1$ = {usd_to_bdt} BDT\n\n"
        output += f"> **‡¶§‡¶•‡ßç‡¶Ø‡¶∏‡ßÇ‡¶§‡ßç‡¶∞:** ‡¶Ü‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶ú‡¶æ‡¶§‡¶ø‡¶ï ‡¶∏‡ßç‡¶™‡¶ü ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡ßü ‡¶™‡¶æ‡¶á‡¶ï‡¶æ‡¶∞‡¶ø ‡¶¶‡¶∞‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶®‡ßç‡¶¨‡ßü‡•§\n\n"

        # ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡ßß: ‡¶™‡¶æ‡¶á‡¶ï‡¶æ‡¶∞‡¶ø ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞
        output += "### ‚öñÔ∏è ‡¶™‡¶æ‡¶á‡¶ï‡¶æ‡¶∞‡¶ø ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶¶‡¶æ‡¶Æ (Wholesale Price)\n"
        output += "| ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ü | ‡¶¨‡¶ø‡¶∂‡ßÅ‡¶¶‡ßç‡¶ß‡¶§‡¶æ | ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ (BDT) | ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶≠‡¶∞‡¶ø (‡ßß‡ßß.‡ß¨‡ß¨‡ß™ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ) |\n"
        output += "| :--- | :--- | :--- | :--- |\n"
        
        # ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡ß®: ‡¶ñ‡ßÅ‡¶ö‡¶∞‡¶æ ‡¶¶‡¶æ‡¶Æ
        retail_table = "\n### üõçÔ∏è ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶ö‡¶∞‡¶æ ‡¶¶‡¶æ‡¶Æ (‡ß®‡ß¶% ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ‡¶∏‡¶π)\n"
        retail_table += "> ‡¶è‡¶á ‡¶¶‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶≠‡ßç‡¶Ø‡¶æ‡¶ü, ‡¶∂‡ßÅ‡¶≤‡ßç‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ú‡ßÅ‡ßü‡ßá‡¶≤‡¶æ‡¶∞‡¶ø ‡¶¶‡ßã‡¶ï‡¶æ‡¶®‡ßá‡¶∞ ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§‡•§\n\n"
        retail_table += "| ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ü | ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ (BDT) | ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶≠‡¶∞‡¶ø (BDT) |\n"
        retail_table += "| :--- | :--- | :--- |\n"

        carats = [
            ("‡ß®‡ß™ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ü", 1.0), 
            ("‡ß®‡ß® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ü", 22/24), 
            ("‡ß®‡ßß ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ü", 21/24), 
            ("‡ßß‡ßÆ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶ü", 18/24)
        ]

        for name, ratio in carats:
            b_gm = p24k_usd * ratio * usd_to_bdt
            wholesale_vhori = b_gm * v_gm
            
            retail_gram = b_gm * 1.20
            retail_vhori = wholesale_vhori * 1.20
            
            output += f"| **{name}** | {round(ratio*100, 1)}% | {f_bdt(b_gm)} ‡ß≥ | {f_bdt(wholesale_vhori)} ‡ß≥ |\n"
            retail_table += f"| **{name}** | {f_bdt(retail_gram)} ‡ß≥ | **{f_bdt(retail_vhori)} ‡ß≥** |\n"
        
        disclaimer = "\n---\n**‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ:** ‡¶è‡¶á ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶Ü‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶ú‡¶æ‡¶§‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ì‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡•§ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßÄ‡ßü ‡¶ú‡ßÅ‡ßü‡ßá‡¶≤‡¶æ‡¶∞‡¶ø ‡¶¶‡ßã‡¶ï‡¶æ‡¶® ‡¶¨‡¶æ ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞‡¶≠‡ßá‡¶¶‡ßá ‡¶¶‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶§‡¶æ‡¶∞‡¶§‡¶Æ‡ßç‡¶Ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶¨‡ßú ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶®‡•§"
        
        return output + retail_table + disclaimer + "\n"
    except Exception as e:
        return f"Error: {e}\n"

def write_to_file(content):
    with open("index.md", "w", encoding="utf-8") as f:
        f.write(content)

if __name__ == "__main__":
    write_to_file(get_gold_price())
